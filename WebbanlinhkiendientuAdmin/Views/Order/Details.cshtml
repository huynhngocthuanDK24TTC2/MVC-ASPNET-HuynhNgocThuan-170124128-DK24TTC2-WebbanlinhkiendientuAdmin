@using WebbanlinhkiendientuAdmin.Models;
@model Order

@{
    ViewBag.Title = "Chi tiết đơn hàng #" + Model.OrderID;
    Layout = "~/Views/Shared/_Layout.cshtml";
    decimal totalAmount = Model.OrderDetails.Sum(x => (x.UnitPrice ?? 0) * (x.Quantity ?? 0));
}

<div class="row">
    <div class="col-lg-12">
        <h2 class="page-header" style="color: #5bc0de; border-bottom: 2px solid #ddd; margin-top: 20px;">
            Chi tiết đơn hàng <small class="text-danger">#@Model.OrderID</small>

            <div class="pull-right">
                @if (Model.isCompleted == true)
                {
                    <span class="label label-success" style="font-size: 60%;"><i class="fa fa-check-circle"></i> Giao thành công</span>
                }
                else if (Model.Shipped == true)
                {
                    <span class="label label-primary" style="font-size: 60%;"><i class="fa fa-truck"></i> Đang vận chuyển</span>
                }
                else if (Model.Dispatched == true)
                {
                    <span class="label label-warning" style="font-size: 60%;"><i class="fa fa-cube"></i> Đã xác nhận</span>
                }
                
                else if (Model.CancelOrder == true)
                {
                    <span class="label label-default" style="font-size: 60%;"><i class="fa fa-times"></i> Đã hủy</span>
                }
                else
                {
                    <span class="label label-danger" style="font-size: 60%;"><i class="fa fa-exclamation-circle"></i> Mới đặt</span>
                }
            </div>
        </h2>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <i class="fa fa-check"></i> @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <i class="fa fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
    </div>
}

<div class="row">
    
    <div class="col-md-6">
        <div class="panel panel-info">
            <div class="panel-heading"><h3 class="panel-title">Thông tin khách hàng</h3></div>
            <div class="panel-body">
                <p><strong>Họ tên:</strong> @(Model.Customer != null ? Model.Customer.First_Name + " " + Model.Customer.Last_Name : "Khách vãng lai")</p>
                <p><strong>SĐT:</strong> @(Model.Customer != null ? Model.Customer.Phone : "---")</p>
                <p><strong>Email:</strong> @(Model.Customer != null ? Model.Customer.Email : "---")</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="panel panel-warning">
            <div class="panel-heading"><h3 class="panel-title">Giao hàng</h3></div>
            <div class="panel-body">
                <p><strong>Địa chỉ:</strong> @(Model.Customer != null ? Model.Customer.Address : "---")</p>
                <p><strong>Ghi chú:</strong> @(string.IsNullOrEmpty(Model.Note) ? "Không có" : Model.Note)</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">Chi tiết sản phẩm</h3></div>
            <div class="panel-body">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr class="active">
                            <th>Sản phẩm</th>
                            <th class="text-center">SL</th>
                            <th class="text-right">Đơn giá</th>
                            <th class="text-right">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderDetails)
                        {
                            <tr>
                                <td>
                                    <img src="@Url.Content(string.IsNullOrEmpty(item.Product?.PicturePath) ? "~/Images/no-image.jpg" : item.Product.PicturePath)" style="width:30px; margin-right:5px;">
                                    @item.Product.Name
                                </td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-right">@string.Format("{0:N0} đ", item.UnitPrice)</td>
                                <td class="text-right font-bold">@string.Format("{0:N0} đ", item.UnitPrice * item.Quantity)</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right font-bold">Tổng cộng:</td>
                            <td class="text-right text-danger font-bold">@string.Format("{0:N0} đ", totalAmount)</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="panel-footer">
                <a href="@Url.Action("Index")" class="btn btn-default"><i class="fa fa-arrow-left"></i> Quay lại</a>

                <div class="pull-right">
                    
                    @if (Model.CancelOrder != true && Model.isCompleted != true && Model.Deliver != true)
                    {
                        if (Model.Dispatched == false)
                        {
                            <a href="@Url.Action("ConfirmOrder", new { id = Model.OrderID })" class="btn btn-primary" onclick="return confirm('Duyệt đơn hàng?');"><i class="fa fa-check"></i> Duyệt đơn</a>
                            <a href="@Url.Action("CancelOrder", new { id = Model.OrderID })" class="btn btn-danger" onclick="return confirm('Hủy đơn hàng này?');"><i class="fa fa-times"></i> Hủy đơn</a>
                        }
                        else if (Model.Shipped == false)
                        {
                            <a href="@Url.Action("StartShip", new { id = Model.OrderID })" class="btn btn-warning" onclick="return confirm('Bắt đầu giao hàng?');"><i class="fa fa-truck"></i> Giao hàng</a>
                        }
                        else
                        {
                            <a href="@Url.Action("MarkCompleted", new { id = Model.OrderID })" class="btn btn-success" onclick="return confirm('Hoàn tất đơn hàng?');"><i class="fa fa-check-circle"></i> Hoàn thành</a>
                        }
                    }
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>